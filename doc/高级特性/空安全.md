### Kotlin 空安全核心知识点总结

#### 一、核心原则
1. **默认非空**  
   Kotlin 类型默认不可为 `null`（编译时检查），防止意外空指针异常（NPE）：
   ```kotlin
   var name: String = "Kotlin"
   name = null // 编译错误！
   ```

2. **显式声明可空**  
   使用 `?` 声明可空类型：
   ```kotlin
   var nickname: String? = null // 合法
   ```

---

#### 二、安全操作符
| 操作符       | 作用                                     | 示例                              |
|--------------|------------------------------------------|-----------------------------------|
| **`?.`**     | 安全调用（null 则返回 null）             | `user?.address?.city`             |
| **`?:`**     | Elvis 操作符（null 时提供默认值）        | `val len = str?.length ?: 0`      |
| **`!!`**     | 非空断言（强制解包，可能抛 NPE）         | `val id = userId!!`（危险！慎用） |
| **`as?`**    | 安全类型转换（失败返回 null）            | `(value as? Int)?.plus(1)`        |

---

#### 三、平台类型（与 Java 互操作）
Java 代码返回的值会被视为**平台类型**（如 `String!`），需手动处理：
```kotlin
// Java: public String getComment() { ... }
val comment: String? = javaObj.getComment() // 建议显式声明可空
val upper = javaObj.getComment().toUpperCase() // 编译通过，但运行时可能 NPE！
```

**改进方案**：
- 使用 `@Nullable` / `@NotNull` 注解 Java 代码
- 调用 Java API 后立即用 `?.` 或 `?:` 处理

---

#### 四、进阶技巧
1. **空检测智能转换**  
   编译器自动推断非空状态：
   ```kotlin
   fun printLength(text: String?) {
       if (text != null) {
           println(text.length) // 此处 text 智能转换为 String
       }
   }
   ```

2. **`let` + 安全调用**  
   链式处理可空对象：
   ```kotlin
   user?.let { 
       sendEmail(it.email) // it 非空
   }
   ```

3. **集合可空性**
    - `List<String>`：元素非空
    - `List<String?>`：元素可空
    - `filterNotNull()`：过滤空元素
      ```kotlin
      val names: List<String?> = listOf("Amy", null, "Bob")
      val validNames = names.filterNotNull() // List<String> ["Amy", "Bob"]
      ```

4. **延迟初始化**  
   避免初始化时不必要的可空性：
   ```kotlin
   lateinit var data: String // 非空，初始化前访问会抛异常
   fun init() {
       data = "Loaded"
   }
   ```

---

#### 五、重要注意事项
1. **避免滥用 `!!`**  
   只在 100% 确定非空时使用（否则用 `?` 或 `?:`）。

2. **与 Java 交互时**
   ```kotlin
   // ❌ 风险写法（可能 NPE）
   javaList.add(JavaObj().nullableValue)

   // ✅ 安全写法
   JavaObj().nullableValue?.let { javaList.add(it) }
   ```

3. **泛型可空性**
   ```kotlin
   Box<String>  // 非空类型
   Box<String?> // 可空类型
   ```

---

### 最佳实践
- 优先使用 `val` 替代 `var` 减少可变状态
- 函数返回值尽量用非空类型（除非必要）
- 对第三方 Java API 做空值封装
- 单元测试中覆盖 null 场景

> 📌 **关键思维**：Kotlin 的空安全是通过**类型系统**在编译期拦截风险，而非运行时检查！通过合理设计类型，可消除大部分 NPE。